{
  "$schema": "../../giraflow/giraflow.schema.json",
  "name": "ChoreMonkey",
  "description": "Household chore management with event sourcing. Modules: Household, Members, Invites, Chores, Activity. Based on 83 integration tests.",
  "version": "2.0.0",

  "timeline": [
    { "type": "comment", "tick": 1, "text": "========== MODULE: HOUSEHOLD ==========" },

    {
      "type": "actor",
      "name": "Parent",
      "tick": 10,
      "sendsCommand": "CreateHousehold"
    },
    {
      "type": "command",
      "name": "CreateHousehold",
      "tick": 20,
      "module": "Household",
      "example": { "name": "The Johnson Family", "pinCode": 4321, "ownerNickname": "Dad" }
    },
    {
      "type": "event",
      "name": "HouseholdCreated",
      "tick": 30,
      "producedBy": "CreateHousehold-20",
      "example": { "householdId": "hh-001", "name": "The Johnson Family", "pinCode": 4321 }
    },
    {
      "type": "event",
      "name": "MemberJoinedHousehold",
      "tick": 31,
      "producedBy": "CreateHousehold-20",
      "example": { "householdId": "hh-001", "memberId": "m-dad", "nickname": "Dad", "isCreator": true }
    },
    {
      "type": "state",
      "name": "HouseholdDetails",
      "tick": 40,
      "module": "Household",
      "sourcedFrom": ["HouseholdCreated", "MemberJoinedHousehold", "AdminPinChanged"],
      "example": { 
        "householdId": "hh-001", 
        "name": "The Johnson Family",
        "hasAdminPin": true,
        "members": [{ "memberId": "m-dad", "nickname": "Dad", "isAdmin": true }]
      }
    },
    {
      "type": "actor",
      "name": "FamilyMember",
      "tick": 50,
      "sendsCommand": "AccessHousehold"
    },
    {
      "type": "command",
      "name": "AccessHousehold",
      "tick": 60,
      "module": "Household",
      "example": { "householdId": "hh-001", "pinCode": 4321, "memberId": "m-dad" }
    },
    {
      "type": "event",
      "name": "AccessGranted",
      "tick": 70,
      "producedBy": "AccessHousehold-60",
      "example": { "householdId": "hh-001", "memberId": "m-dad", "isAdmin": true }
    },
    {
      "type": "actor",
      "name": "Admin",
      "tick": 80,
      "sendsCommand": "SetAdminPin"
    },
    {
      "type": "command",
      "name": "SetAdminPin",
      "tick": 90,
      "module": "Household",
      "example": { "householdId": "hh-001", "newPin": 9999 }
    },
    {
      "type": "event",
      "name": "AdminPinChanged",
      "tick": 100,
      "producedBy": "SetAdminPin-90",
      "example": { "householdId": "hh-001", "newPinHash": "abc123..." }
    },

    { "type": "comment", "tick": 199, "text": "========== MODULE: INVITES ==========" },

    {
      "type": "actor",
      "name": "Admin",
      "tick": 200,
      "readsView": "HouseholdDetails",
      "sendsCommand": "GenerateInvite"
    },
    {
      "type": "command",
      "name": "GenerateInvite",
      "tick": 210,
      "module": "Invites",
      "example": { "householdId": "hh-001" }
    },
    {
      "type": "event",
      "name": "InviteGenerated",
      "tick": 220,
      "producedBy": "GenerateInvite-210",
      "example": { "householdId": "hh-001", "inviteId": "inv-001" }
    },
    {
      "type": "state",
      "name": "InviteLink",
      "tick": 230,
      "module": "Invites",
      "sourcedFrom": ["InviteGenerated"],
      "example": { "inviteId": "inv-001", "link": "https://choremonkey.app/join/inv-001" }
    },

    { "type": "comment", "tick": 299, "text": "========== MODULE: MEMBERS ==========" },

    {
      "type": "actor",
      "name": "NewMember",
      "tick": 300,
      "sendsCommand": "JoinHousehold"
    },
    {
      "type": "command",
      "name": "JoinHousehold",
      "tick": 310,
      "module": "Members",
      "example": { "householdId": "hh-001", "inviteId": "inv-001", "nickname": "Emma" }
    },
    {
      "type": "event",
      "name": "MemberJoinedHousehold",
      "tick": 320,
      "producedBy": "JoinHousehold-310",
      "example": { "householdId": "hh-001", "memberId": "m-emma", "nickname": "Emma", "isCreator": false }
    },
    {
      "type": "state",
      "name": "MemberList",
      "tick": 330,
      "module": "Members",
      "sourcedFrom": ["MemberJoinedHousehold", "MemberNicknameChanged", "MemberStatusChanged", "MemberRemoved"],
      "example": {
        "members": [
          { "memberId": "m-dad", "nickname": "Dad", "status": null },
          { "memberId": "m-emma", "nickname": "Emma", "status": "Doing homework ðŸ“š" }
        ]
      }
    },
    {
      "type": "actor",
      "name": "FamilyMember",
      "tick": 340,
      "sendsCommand": "ChangeMemberNickname"
    },
    {
      "type": "command",
      "name": "ChangeMemberNickname",
      "tick": 350,
      "module": "Members",
      "example": { "householdId": "hh-001", "memberId": "m-emma", "newNickname": "Emmy" }
    },
    {
      "type": "event",
      "name": "MemberNicknameChanged",
      "tick": 360,
      "producedBy": "ChangeMemberNickname-350",
      "example": { "householdId": "hh-001", "memberId": "m-emma", "newNickname": "Emmy" }
    },
    {
      "type": "actor",
      "name": "FamilyMember",
      "tick": 370,
      "sendsCommand": "ChangeMemberStatus"
    },
    {
      "type": "command",
      "name": "ChangeMemberStatus",
      "tick": 380,
      "module": "Members",
      "example": { "householdId": "hh-001", "memberId": "m-emma", "status": "At soccer practice âš½" }
    },
    {
      "type": "event",
      "name": "MemberStatusChanged",
      "tick": 390,
      "producedBy": "ChangeMemberStatus-380",
      "example": { "householdId": "hh-001", "memberId": "m-emma", "status": "At soccer practice âš½" }
    },
    {
      "type": "actor",
      "name": "FamilyMember",
      "tick": 395,
      "sendsCommand": "SetMemberPin"
    },
    {
      "type": "command",
      "name": "SetMemberPin",
      "tick": 396,
      "module": "Members",
      "example": { "householdId": "hh-001", "memberId": "m-emma", "pin": 1234 }
    },
    {
      "type": "event",
      "name": "MemberPinSet",
      "tick": 397,
      "producedBy": "SetMemberPin-396",
      "example": { "householdId": "hh-001", "memberId": "m-emma", "pinHash": "xyz789..." }
    },
    {
      "type": "actor",
      "name": "Admin",
      "tick": 400,
      "sendsCommand": "RemoveMember"
    },
    {
      "type": "command",
      "name": "RemoveMember",
      "tick": 410,
      "module": "Members",
      "example": { "householdId": "hh-001", "memberId": "m-emma", "adminPin": 4321 }
    },
    {
      "type": "event",
      "name": "MemberRemoved",
      "tick": 420,
      "producedBy": "RemoveMember-410",
      "example": { "householdId": "hh-001", "memberId": "m-emma", "removedBy": "m-dad" }
    },

    { "type": "comment", "tick": 499, "text": "========== MODULE: CHORES ==========" },

    {
      "type": "actor",
      "name": "Admin",
      "tick": 500,
      "readsView": "MemberList",
      "sendsCommand": "AddChore"
    },
    {
      "type": "command",
      "name": "AddChore",
      "tick": 510,
      "module": "Chores",
      "example": { 
        "householdId": "hh-001", 
        "displayName": "Make Bed", 
        "description": "Every morning",
        "frequency": { "type": "daily" },
        "isOptional": false
      }
    },
    {
      "type": "event",
      "name": "ChoreCreated",
      "tick": 520,
      "producedBy": "AddChore-510",
      "example": { 
        "householdId": "hh-001", 
        "choreId": "c-bed",
        "displayName": "Make Bed",
        "frequency": { "type": "daily" },
        "isOptional": false
      }
    },
    {
      "type": "command",
      "name": "AddChore",
      "tick": 530,
      "module": "Chores",
      "example": { 
        "householdId": "hh-001", 
        "displayName": "Wash Car", 
        "frequency": { "type": "weekly-anyday" },
        "isOptional": true
      }
    },
    {
      "type": "event",
      "name": "ChoreCreated",
      "tick": 540,
      "producedBy": "AddChore-530",
      "example": { 
        "householdId": "hh-001", 
        "choreId": "c-car",
        "displayName": "Wash Car",
        "frequency": { "type": "weekly-anyday" },
        "isOptional": true
      }
    },
    {
      "type": "state",
      "name": "ChoreList",
      "tick": 550,
      "module": "Chores",
      "sourcedFrom": ["ChoreCreated", "ChoreAssigned", "ChoreCompleted", "ChoreDeleted"],
      "example": [
        { "choreId": "c-bed", "displayName": "Make Bed", "frequency": { "type": "daily" }, "isOptional": false },
        { "choreId": "c-car", "displayName": "Wash Car", "frequency": { "type": "weekly-anyday" }, "isOptional": true }
      ]
    },
    {
      "type": "actor",
      "name": "Admin",
      "tick": 560,
      "readsView": "ChoreList",
      "sendsCommand": "AssignChore"
    },
    {
      "type": "command",
      "name": "AssignChore",
      "tick": 570,
      "module": "Chores",
      "example": { "householdId": "hh-001", "choreId": "c-bed", "memberIds": ["m-emma", "m-jake"], "assignToAll": false }
    },
    {
      "type": "event",
      "name": "ChoreAssigned",
      "tick": 580,
      "producedBy": "AssignChore-570",
      "example": { "householdId": "hh-001", "choreId": "c-bed", "assignedTo": ["m-emma", "m-jake"], "assignToAll": false }
    },
    {
      "type": "actor",
      "name": "FamilyMember",
      "tick": 600,
      "role": "Emma",
      "readsView": "MyChores",
      "sendsCommand": "CompleteChore"
    },
    {
      "type": "state",
      "name": "MyChores",
      "tick": 610,
      "module": "Chores",
      "sourcedFrom": ["ChoreCreated", "ChoreAssigned", "ChoreCompleted"],
      "example": {
        "memberId": "m-emma",
        "chores": [
          { "choreId": "c-bed", "displayName": "Make Bed", "completedToday": false },
          { "choreId": "c-car", "displayName": "Wash Car", "completedThisWeek": true, "isOptional": true }
        ]
      }
    },
    {
      "type": "command",
      "name": "CompleteChore",
      "tick": 620,
      "module": "Chores",
      "example": { "householdId": "hh-001", "choreId": "c-bed", "memberId": "m-emma" }
    },
    {
      "type": "event",
      "name": "ChoreCompleted",
      "tick": 630,
      "producedBy": "CompleteChore-620",
      "example": { 
        "householdId": "hh-001", 
        "choreId": "c-bed", 
        "memberId": "m-emma",
        "memberName": "Emma",
        "completedAt": "2026-02-14T08:00:00Z"
      }
    },
    {
      "type": "state",
      "name": "ChoreHistory",
      "tick": 640,
      "module": "Chores",
      "sourcedFrom": ["ChoreCompleted"],
      "example": {
        "choreId": "c-bed",
        "completions": [
          { "memberId": "m-emma", "memberName": "Emma", "completedAt": "2026-02-14T08:00:00Z" }
        ]
      }
    },
    {
      "type": "state",
      "name": "OverdueChores",
      "tick": 650,
      "module": "Chores",
      "sourcedFrom": ["ChoreCreated", "ChoreAssigned", "ChoreCompleted", "ChoreMissedAcknowledged"],
      "example": {
        "chores": [
          { "choreId": "c-bed", "displayName": "Make Bed", "assignedTo": ["m-jake"], "dueDate": "2026-02-13" }
        ]
      }
    },
    {
      "type": "actor",
      "name": "Admin",
      "tick": 660,
      "readsView": "OverdueChores",
      "sendsCommand": "AcknowledgeMissed"
    },
    {
      "type": "command",
      "name": "AcknowledgeMissed",
      "tick": 670,
      "module": "Chores",
      "example": { "householdId": "hh-001", "choreId": "c-bed", "memberId": "m-jake", "dueDate": "2026-02-13" }
    },
    {
      "type": "event",
      "name": "ChoreMissedAcknowledged",
      "tick": 680,
      "producedBy": "AcknowledgeMissed-670",
      "example": { "householdId": "hh-001", "choreId": "c-bed", "memberId": "m-jake", "dueDate": "2026-02-13" }
    },
    {
      "type": "actor",
      "name": "Admin",
      "tick": 700,
      "sendsCommand": "DeleteChore"
    },
    {
      "type": "command",
      "name": "DeleteChore",
      "tick": 710,
      "module": "Chores",
      "example": { "householdId": "hh-001", "choreId": "c-car", "adminPin": 4321 }
    },
    {
      "type": "event",
      "name": "ChoreDeleted",
      "tick": 720,
      "producedBy": "DeleteChore-710",
      "example": { "householdId": "hh-001", "choreId": "c-car", "deletedBy": "m-dad" }
    },

    { "type": "comment", "tick": 799, "text": "========== MODULE: ACTIVITY ==========" },

    {
      "type": "state",
      "name": "CompletionTimeline",
      "tick": 800,
      "module": "Activity",
      "sourcedFrom": ["ActivityRecorded"],
      "example": {
        "activities": [
          { "type": "ChoreCompleted", "actorName": "Emma", "choreName": "Make Bed", "timestamp": "2026-02-14T08:00:00Z" },
          { "type": "MemberJoined", "actorName": "Jake", "timestamp": "2026-02-14T07:00:00Z" },
          { "type": "ChoreCreated", "actorName": "Dad", "choreName": "Take Out Trash", "timestamp": "2026-02-14T06:00:00Z" }
        ]
      }
    },
    {
      "type": "actor",
      "name": "FamilyMember",
      "tick": 810,
      "readsView": "CompletionTimeline"
    },
    {
      "type": "state",
      "name": "TeamOverview",
      "tick": 820,
      "module": "Activity",
      "sourcedFrom": ["ChoreCreated", "ChoreAssigned", "ChoreCompleted", "MemberJoinedHousehold"],
      "example": {
        "members": [
          { 
            "memberId": "m-emma", 
            "nickname": "Emma",
            "chores": [
              { "choreId": "c-bed", "displayName": "Make Bed", "completedToday": true }
            ]
          },
          { 
            "memberId": "m-jake", 
            "nickname": "Jake",
            "chores": [
              { "choreId": "c-bed", "displayName": "Make Bed", "completedToday": false }
            ]
          }
        ]
      }
    },
    {
      "type": "actor",
      "name": "Admin",
      "tick": 830,
      "readsView": "TeamOverview"
    }
  ],

  "specifications": [
    {
      "name": "CreateHousehold",
      "type": "command",
      "module": "Household",
      "scenarios": [
        {
          "name": "Returns household ID and member ID",
          "steps": [
            { "type": "command", "when": { "name": "The Smiths", "pinCode": 1234 }, "produces": [
              { "event": "HouseholdCreated", "data": { "householdId": "hh-*", "name": "The Smiths" } },
              { "event": "MemberJoinedHousehold", "data": { "memberId": "m-*", "isCreator": true } }
            ]}
          ]
        }
      ]
    },
    {
      "name": "AccessHousehold",
      "type": "command",
      "module": "Household",
      "scenarios": [
        {
          "name": "Valid admin PIN grants admin access",
          "steps": [
            { "type": "command", "when": { "pinCode": 4321 }, "produces": [
              { "event": "AccessGranted", "data": { "isAdmin": true } }
            ]}
          ]
        },
        {
          "name": "Valid member PIN grants member access",
          "steps": [
            { "type": "command", "when": { "memberId": "m-emma", "pin": 1234 }, "produces": [
              { "event": "AccessGranted", "data": { "isAdmin": false } }
            ]}
          ]
        }
      ]
    },
    {
      "name": "JoinHousehold",
      "type": "command",
      "module": "Members",
      "scenarios": [
        {
          "name": "Valid invite - becomes member",
          "steps": [
            { "type": "events-only", "events": [
              { "event": "InviteGenerated", "data": { "inviteId": "inv-001" } }
            ]},
            { "type": "command", "when": { "inviteId": "inv-001", "nickname": "Kid1" }, "produces": [
              { "event": "MemberJoinedHousehold", "data": { "nickname": "Kid1", "isCreator": false } }
            ]}
          ]
        },
        {
          "name": "Invalid invite - rejected",
          "steps": [
            { "type": "command", "when": { "inviteId": "fake-invite" }, "fails": "Invalid invite" }
          ]
        }
      ]
    },
    {
      "name": "RemoveMember",
      "type": "command",
      "module": "Members",
      "scenarios": [
        {
          "name": "Admin can remove member with PIN",
          "steps": [
            { "type": "command", "when": { "memberId": "m-emma", "adminPin": 4321 }, "produces": [
              { "event": "MemberRemoved", "data": { "memberId": "m-emma" } }
            ]}
          ]
        },
        {
          "name": "Cannot remove household creator",
          "steps": [
            { "type": "command", "when": { "memberId": "m-dad", "adminPin": 4321 }, "fails": "Cannot remove household creator" }
          ]
        }
      ]
    },
    {
      "name": "AddChore",
      "type": "command",
      "module": "Chores",
      "scenarios": [
        {
          "name": "Daily frequency",
          "steps": [
            { "type": "command", "when": { "displayName": "Make Bed", "frequency": { "type": "daily" } }, "produces": [
              { "event": "ChoreCreated", "data": { "frequency": { "type": "daily" } } }
            ]}
          ]
        },
        {
          "name": "Weekly with specific days",
          "steps": [
            { "type": "command", "when": { "displayName": "Trash", "frequency": { "type": "weekly", "days": ["monday", "thursday"] } }, "produces": [
              { "event": "ChoreCreated", "data": { "frequency": { "type": "weekly", "days": ["monday", "thursday"] } } }
            ]}
          ]
        },
        {
          "name": "Weekly-anyday (complete once per week)",
          "steps": [
            { "type": "command", "when": { "displayName": "Vacuum", "frequency": { "type": "weekly-anyday" } }, "produces": [
              { "event": "ChoreCreated", "data": { "frequency": { "type": "weekly-anyday" } } }
            ]}
          ]
        },
        {
          "name": "Optional/bonus chore",
          "steps": [
            { "type": "command", "when": { "displayName": "Wash Car", "isOptional": true }, "produces": [
              { "event": "ChoreCreated", "data": { "isOptional": true } }
            ]}
          ]
        }
      ]
    },
    {
      "name": "CompleteChore",
      "type": "command",
      "module": "Chores",
      "scenarios": [
        {
          "name": "Records completion with member name",
          "steps": [
            { "type": "command", "when": { "choreId": "c-001", "memberId": "m-001" }, "produces": [
              { "event": "ChoreCompleted", "data": { "memberId": "m-001", "memberName": "Emma" } }
            ]}
          ]
        },
        {
          "name": "Unassigned chore auto-assigns on completion",
          "steps": [
            { "type": "command", "when": { "choreId": "c-unassigned", "memberId": "m-002" }, "produces": [
              { "event": "ChoreAssigned", "data": { "assignedTo": ["m-002"] } },
              { "event": "ChoreCompleted", "data": { "memberId": "m-002" } }
            ]}
          ]
        }
      ]
    },
    {
      "name": "DeleteChore",
      "type": "command",
      "module": "Chores",
      "scenarios": [
        {
          "name": "Admin can delete with PIN",
          "steps": [
            { "type": "command", "when": { "choreId": "c-001", "adminPin": 4321 }, "produces": [
              { "event": "ChoreDeleted", "data": { "choreId": "c-001" } }
            ]}
          ]
        },
        {
          "name": "Invalid PIN rejected",
          "steps": [
            { "type": "command", "when": { "choreId": "c-001", "adminPin": 0000 }, "fails": "Invalid PIN" }
          ]
        }
      ]
    },
    {
      "name": "OverdueChores",
      "type": "state",
      "module": "Chores",
      "scenarios": [
        {
          "name": "Daily chore not completed shows as overdue after grace period",
          "initialState": { "chores": [] },
          "steps": [
            {
              "given": { "event": "ChoreCreated", "data": { "choreId": "c-001", "frequency": { "type": "daily" }, "isOptional": false } },
              "then": { "description": "Chore exists, checking if overdue based on last completion and grace period" }
            }
          ]
        },
        {
          "name": "Optional chores never appear in overdue",
          "initialState": { "chores": [] },
          "steps": [
            {
              "given": { "event": "ChoreCreated", "data": { "choreId": "c-bonus", "isOptional": true } },
              "then": { "chores": [] }
            }
          ]
        }
      ]
    },
    {
      "name": "CompletionTimeline",
      "type": "state",
      "module": "Activity",
      "scenarios": [
        {
          "name": "Records multiple activity types",
          "initialState": { "activities": [] },
          "steps": [
            {
              "given": { "event": "ActivityRecorded", "data": { "type": "ChoreCompleted", "actorName": "Emma" } },
              "then": { "activities": [{ "type": "ChoreCompleted", "actorName": "Emma" }] }
            },
            {
              "given": { "event": "ActivityRecorded", "data": { "type": "MemberJoined", "actorName": "Jake" } },
              "then": { "activities": [{ "type": "MemberJoined" }, { "type": "ChoreCompleted" }] }
            }
          ]
        }
      ]
    }
  ]
}
