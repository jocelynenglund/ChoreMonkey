name: Build and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  NODE_VERSION: '22'
  AZURE_WEBAPP_NAME: itsybitsylist-api

jobs:
  build-and-deploy-api:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Configure NuGet
        run: |
          dotnet nuget update source github \
            --username jocelynenglund \
            --password ${{ secrets.NUGET_AUTH_TOKEN }} \
            --store-password-in-clear-text

      - run: dotnet restore
          
      - run: dotnet build --configuration Release --no-restore -p:SourceRevisionId=${{ github.sha }}
      
      - run: dotnet publish ChoreMonkey.ApiService/ChoreMonkey.ApiService.csproj -c Release -o ./publish -p:SourceRevisionId=${{ github.sha }}

      - uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./publish

  build-and-deploy-frontend:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: nestle-together/package-lock.json

      - working-directory: nestle-together
        run: npm ci

      - name: Build frontend
        working-directory: nestle-together
        env:
          VITE_API_URL: https://itsybitsylist-api.azurewebsites.net
          BUILD_VERSION: ${{ format('{0}.{1}.{2}.{3}', 2026, github.run_number / 10000 % 100 + 1, github.run_number % 100, github.run_number) }}
          BUILD_TIME: ${{ github.event.head_commit.timestamp }}
          GIT_SHA: ${{ github.sha }}
        run: |
          # Generate version: YYYY.MM.DD.run_number
          export BUILD_VERSION=$(date -u +%Y.%m.%d).${{ github.run_number }}
          npm run build

      - name: Deploy to Production (choremonkey)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: nestle-together/dist/
          server-dir: /choremonkey/